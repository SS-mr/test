#!/usr/bin/env php
<?php
declare(strict_types=1);

require __DIR__ . '/vendor/autoload.php';

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;
use PhpParser\ParserFactory;

if ($argc < 3) {
    fwrite(STDERR, "Usage: php analyzer.php <target_dir> <output.xlsx>\n");
    exit(1);
}

$targetDir  = $argv[1];
$outputFile = $argv[2];

if (!is_dir($targetDir)) {
    fwrite(STDERR, "Error: '{$targetDir}' is not a directory.\n");
    exit(1);
}

// ParserFactory を将来の AST 解析用にインスタンス化
$parser = (new ParserFactory())->createForNewestSupportedVersion();

$spreadsheet = new Spreadsheet();
$sheetCount  = 0;

// 再帰的に .php ファイルを走査
$rii = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($targetDir));
foreach ($rii as $file) {
    if (!$file->isFile() || $file->getExtension() !== 'php') {
        continue;
    }

    $path    = $file->getPathname();
    $content = file_get_contents($path);
    $crudMap = analyzeCrud($content);

    // シート作成（最初は既存シートを利用、それ以降は新規作成）
    $sheet = $sheetCount === 0
        ? $spreadsheet->getActiveSheet()
        : $spreadsheet->createSheet();
    // シート名はファイル名（長すぎる場合は切り詰め）
    $title = mb_substr($file->getBasename(), 0, 28);
    $sheet->setTitle($title);

    // ヘッダー
    $sheet->fromArray(['Table', 'C', 'R', 'U', 'D'], null, 'A1');

    // CRUD データ書き込み
    $row = 2;
    foreach ($crudMap as $table => $ops) {
        $sheet->setCellValue("A{$row}", $table);
        $sheet->setCellValue("B{$row}", $ops['C'] ? '○' : '');
        $sheet->setCellValue("C{$row}", $ops['R'] ? '○' : '');
        $sheet->setCellValue("D{$row}", $ops['U'] ? '○' : '');
        $sheet->setCellValue("E{$row}", $ops['D'] ? '○' : '');
        $row++;
    }

    $sheetCount++;
}

// ファイル保存
$writer = new Xlsx($spreadsheet);
$writer->save($outputFile);

echo "✔ {$outputFile} を生成しました。\n";


/**
 * 簡易版：ファイル本文から正規表現で CRUD 操作を検出
 *   C => INSERT INTO
 *   R => SELECT … FROM
 *   U => UPDATE
 *   D => DELETE FROM
 */
function analyzeCrud(string $content): array
{
    $map = [];
    $patterns = [
        'C' => '/INSERT\s+INTO\s+`?([a-zA-Z0-9_]+)`?/i',
        'R' => '/SELECT\b.*?\bFROM\s+`?([a-zA-Z0-9_]+)`?/is',
        'U' => '/UPDATE\s+`?([a-zA-Z0-9_]+)`?/i',
        'D' => '/DELETE\s+FROM\s+`?([a-zA-Z0-9_]+)`?/i',
    ];

    foreach ($patterns as $op => $pat) {
        if (preg_match_all($pat, $content, $m)) {
            foreach ($m[1] as $table) {
                if (!isset($map[$table])) {
                    $map[$table] = ['C'=>false,'R'=>false,'U'=>false,'D'=>false];
                }
                $map[$table][$op] = true;
            }
        }
    }

    return $map;
}